#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from kivy.app import App
from kivy.lang import Builder
from kivy.uix.screenmanager import Screen
from kivy.clock import mainthread
from manager import RosManager

class MainApp(App):
    def build(self):
        self.manager = RosManager(status_callback=self.update_status_label)
        
        kv_design = """
ScreenManager:
    id: sm
    
    Screen:
        name: 'main_menu'
        BoxLayout:
            orientation: 'vertical'
            padding: 40
            spacing: 20
            Label:
                id: status_label
                text: 'Waiter Bot Control Center'
                font_size: '30sp'
            Button:
                text: 'Mulai Sesi Mapping'
                font_size: '22sp'
                on_press: sm.current = 'pre_mapping'

    Screen:
        name: 'pre_mapping'
        BoxLayout:
            orientation: 'vertical'
            padding: 40
            spacing: 20
            Label:
                text: 'Masukkan Nama Peta'
                font_size: '26sp'
            TextInput:
                id: map_name_input
                hint_text: 'Contoh: peta_lab_1'
                font_size: '20sp'
                multiline: False
                size_hint_y: None
                height: '48dp'
            Button:
                text: 'Buka Terminal Mapping'
                font_size: '22sp'
                on_press: app.start_mapping_session()
            Button:
                text: 'Kembali'
                font_size: '22sp'
                on_press: sm.current = 'main_menu'

    Screen:
        name: 'mapping_in_progress'
        BoxLayout:
            orientation: 'vertical'
            padding: 40
            spacing: 20
            Label:
                id: mapping_status_label
                text: 'Sesi mapping sedang berlangsung di terminal lain...'
                font_size: '20sp'
            Label:
                id: current_map_name_label
                font_size: '16sp'
            Button:
                text: 'Selesai & Simpan Peta'
                font_size: '22sp'
                on_press: app.stop_mapping_session()
"""
        return Builder.load_string(kv_design)

    def start_mapping_session(self):
        screen = self.root.get_screen('pre_mapping')
        map_name = screen.ids.map_name_input.text

        if not map_name.strip():
            screen.ids.map_name_input.hint_text = 'NAMA PETA WAJIB DIISI!'
            return

        status = self.manager.start_mapping(map_name)
        
        # Pindah ke layar "sedang mapping"
        in_progress_screen = self.root.get_screen('mapping_in_progress')
        in_progress_screen.ids.mapping_status_label.text = status
        in_progress_screen.ids.current_map_name_label.text = f"Peta akan disimpan sebagai: {map_name}"
        self.root.current = 'mapping_in_progress'

    def stop_mapping_session(self):
        status = self.manager.save_and_stop_mapping()
        self.update_status_label('mapping_in_progress', 'mapping_status_label', status)
        
        # Kembali ke menu utama
        self.root.current = 'main_menu'

    def on_stop(self):
        self.manager.shutdown()

    @mainthread
    def update_status_label(self, screen_name, label_id, new_text):
        if self.root:
            screen = self.root.get_screen(screen_name)
            if screen and label_id in screen.ids:
                screen.ids[label_id].text = new_text

if __name__ == '__main__':
    MainApp().run()
